#!/system/bin/bash

IFS='' read -r -d '' LOGO <<"EOF"
[38;5;33m [0m[38;5;33m [0m[38;5;39m [0m[38;5;39m [0m[38;5;44m_[0m[38;5;44m_[0m[38;5;44m_[0m[38;5;49m_[0m[38;5;49m [0m[38;5;49m [0m[38;5;48m_[0m[38;5;48m [0m[38;5;83m [0m[38;5;83m [0m[38;5;83m_[0m[38;5;118m_[0m[38;5;118m_[0m[38;5;154m_[0m[38;5;154m_[0m[38;5;154m_[0m[38;5;184m_[0m[38;5;184m [0m[38;5;184m [0m[38;5;214m [0m[38;5;214m [0m[38;5;208m [0m[38;5;208m [0m[38;5;208m [0m[38;5;203m [0m[38;5;203m [0m[38;5;203m [0m[38;5;198m [0m[38;5;198m [0m[38;5;199m [0m[38;5;199m [0m[38;5;163m [0m[38;5;164m [0m[38;5;164m [0m[38;5;128m [0m[38;5;129m [0m[38;5;129m [0m[38;5;93m [0m[38;5;93m [0m[38;5;63m [0m[38;5;63m [0m[38;5;63m [0m[38;5;33m [0m[38;5;33m [0m
[38;5;39m [0m[38;5;44m [0m[38;5;44m [0m[38;5;44m/[0m[38;5;49m [0m[38;5;49m_[0m[38;5;49m_[0m[38;5;48m [0m[38;5;48m\[0m[38;5;83m/[0m[38;5;83m [0m[38;5;83m|[0m[38;5;118m [0m[38;5;118m/[0m[38;5;154m [0m[38;5;154m/[0m[38;5;154m [0m[38;5;184m_[0m[38;5;184m_[0m[38;5;184m_[0m[38;5;214m/[0m[38;5;214m_[0m[38;5;208m_[0m[38;5;208m_[0m[38;5;208m_[0m[38;5;203m [0m[38;5;203m_[0m[38;5;203m_[0m[38;5;198m_[0m[38;5;198m [0m[38;5;199m [0m[38;5;199m_[0m[38;5;163m_[0m[38;5;164m_[0m[38;5;164m_[0m[38;5;128m [0m[38;5;129m_[0m[38;5;129m_[0m[38;5;93m_[0m[38;5;93m_[0m[38;5;63m_[0m[38;5;63m_[0m[38;5;63m_[0m[38;5;33m_[0m[38;5;33m_[0m[38;5;33m_[0m[38;5;39m [0m[38;5;39m_[0m
[38;5;44m [0m[38;5;49m [0m[38;5;49m/[0m[38;5;49m [0m[38;5;48m/[0m[38;5;48m [0m[38;5;83m/[0m[38;5;83m [0m[38;5;83m/[0m[38;5;118m [0m[38;5;118m [0m[38;5;154m|[0m[38;5;154m/[0m[38;5;154m [0m[38;5;184m/[0m[38;5;184m\[0m[38;5;184m_[0m[38;5;214m_[0m[38;5;214m [0m[38;5;208m\[0m[38;5;208m/[0m[38;5;208m [0m[38;5;203m_[0m[38;5;203m_[0m[38;5;203m [0m[38;5;198m`[0m[38;5;198m_[0m[38;5;199m_[0m[38;5;199m [0m[38;5;163m\[0m[38;5;164m/[0m[38;5;164m [0m[38;5;128m_[0m[38;5;129m_[0m[38;5;129m [0m[38;5;93m`[0m[38;5;93m/[0m[38;5;63m [0m[38;5;63m_[0m[38;5;63m_[0m[38;5;33m_[0m[38;5;33m/[0m[38;5;33m [0m[38;5;39m_[0m[38;5;39m_[0m[38;5;44m [0m[38;5;44m`[0m[38;5;44m/[0m
[38;5;49m [0m[38;5;48m/[0m[38;5;48m [0m[38;5;83m/[0m[38;5;83m_[0m[38;5;83m/[0m[38;5;118m [0m[38;5;118m/[0m[38;5;154m [0m[38;5;154m/[0m[38;5;154m|[0m[38;5;184m [0m[38;5;184m [0m[38;5;184m/[0m[38;5;214m_[0m[38;5;214m_[0m[38;5;208m_[0m[38;5;208m/[0m[38;5;208m [0m[38;5;203m/[0m[38;5;203m [0m[38;5;203m/[0m[38;5;198m [0m[38;5;198m/[0m[38;5;199m [0m[38;5;199m/[0m[38;5;163m [0m[38;5;164m/[0m[38;5;164m [0m[38;5;128m/[0m[38;5;129m [0m[38;5;129m/[0m[38;5;93m_[0m[38;5;93m/[0m[38;5;63m [0m[38;5;63m([0m[38;5;63m_[0m[38;5;33m_[0m[38;5;33m [0m[38;5;33m [0m[38;5;39m)[0m[38;5;39m [0m[38;5;44m/[0m[38;5;44m_[0m[38;5;44m/[0m[38;5;49m [0m[38;5;49m/[0m[38;5;49m [0m
[38;5;83m/[0m[38;5;83m_[0m[38;5;83m_[0m[38;5;118m_[0m[38;5;118m_[0m[38;5;154m_[0m[38;5;154m/[0m[38;5;154m_[0m[38;5;184m/[0m[38;5;184m [0m[38;5;184m|[0m[38;5;214m_[0m[38;5;214m/[0m[38;5;208m/[0m[38;5;208m_[0m[38;5;208m_[0m[38;5;203m_[0m[38;5;203m_[0m[38;5;203m/[0m[38;5;198m_[0m[38;5;198m/[0m[38;5;199m [0m[38;5;199m/[0m[38;5;163m_[0m[38;5;164m/[0m[38;5;164m [0m[38;5;128m/[0m[38;5;129m_[0m[38;5;129m/[0m[38;5;93m\[0m[38;5;93m_[0m[38;5;63m_[0m[38;5;63m,[0m[38;5;63m_[0m[38;5;33m/[0m[38;5;33m_[0m[38;5;33m_[0m[38;5;39m_[0m[38;5;39m_[0m[38;5;44m/[0m[38;5;44m\[0m[38;5;44m_[0m[38;5;49m_[0m[38;5;49m,[0m[38;5;49m [0m[38;5;48m/[0m[38;5;48m [0m[38;5;83m [0m
[38;5;118m [0m[38;5;118m [0m[38;5;154m [0m[38;5;154m [0m[38;5;154m [0m[38;5;184m [0m[38;5;184m [0m[38;5;184m [0m[38;5;214m [0m[38;5;214m [0m[38;5;208m [0m[38;5;208m [0m[38;5;208m [0m[38;5;203m [0m[38;5;203m [0m[38;5;203m [0m[38;5;198m [0m[38;5;198m [0m[38;5;199m [0m[38;5;199m [0m[38;5;163m [0m[38;5;164m [0m[38;5;164m [0m[38;5;128m [0m[38;5;129m [0m[38;5;129m [0m[38;5;93m [0m[38;5;93m [0m[38;5;63m [0m[38;5;63m [0m[38;5;63m [0m[38;5;33m [0m[38;5;33m [0m[38;5;33m [0m[38;5;39m [0m[38;5;39m [0m[38;5;44m [0m[38;5;44m [0m[38;5;44m [0m[38;5;49m [0m[38;5;49m [0m[38;5;49m [0m[38;5;48m/[0m[38;5;48m_[0m[38;5;83m/[0m[38;5;83m [0m[38;5;83m [0m[38;5;118m [0m
[38;5;208m [0m[38;5;203m [0m[38;5;203m [0m[38;5;203m [0m[38;5;198m [0m[38;5;198m [0m[38;5;199mï¼[0m[38;5;199mï¼[0m[38;5;163mï¼[0m[38;5;164mï¼[0m[38;5;164mï¼[0m[38;5;128mï¼[0m[38;5;129mï¼[0m[38;5;129mï¼[0m[38;5;93mï¼[0m[38;5;93m [0m[38;5;99m [0m[38;5;63mï½–[0m[38;5;63mï¼’[0m[38;5;69mï¼Ž[0m[38;5;33mï¼˜[0m[38;5;33mï¼[0m
EOF

umask 022

CAT=/system/bin/cat
KILL=/system/bin/kill

BINDIR="$(dirname "$0")"

PIDDIR=/data/dnsmasq

DNSMASQ=/system/xbin/dnsmasq
PIDFILE=$PIDDIR/dnsmasq.pid
CONFFILE=$PIDDIR/dnsmasq.conf

#/system/xbin/dnsmasq -C -x #/data/local/dnsmasq.pid &

SCRIPT="exec env $DNSMASQ -C $CONFFILE -x $PIDFILE &"

start_service() {
    # XXX We really should check if the service is already going, but
    # XXX we will opt out at this time. - Bal

    # Check to see if we have keys that need to be made
    echo 'Starting dnsmasq..' >&2

    if [[ -f "$PIDFILE" ]] && [[ -s "$PIDFILE" ]] && su -c kill -0 `su -c cat "$PIDFILE"`; then
       echo 'dnsmasq already running' >&2
       return 1
    fi

    su -c "$SCRIPT"

    sleep 2

    if [[ -f "$PIDFILE" ]] && [[ -s "$PIDFILE" ]] && su -c kill -0 `su -c cat "$PIDFILE"`; then
       PID=`su -c cat "$PIDFILE"`
       echo "dnsmasq is now running, the PID is $PID"
       return 0
    else
       echo ''
       echo "Error! Could not start dnsmasq!"
    fi
}

stop_service() {
  echo 'Stopping dnsmasq..' >&2
  if [[ ! -f "$PIDFILE" ]] || ! su -c kill -0 `su -c cat "$PIDFILE"`; then
    echo 'dnsmasq is not running' >&2
    return 1
  fi
  su -c kill -15 `cat "$PIDFILE"` && su -c rm -f "$PIDFILE"
  echo 'dnsmasq has stopped' >&2
}

show_status() {
    echo "Checking dnsmasq..."
    if [[ -f "$PIDFILE" ]] && [[ -s "$PIDFILE" ]]; then
        PID=`su -c cat "$PIDFILE"`
        PS_OUT="$(su -c ps -Af)"
	flag=`echo "$PS_OUT" | grep "$PID"`
	if [[ -z "$flag" ]]; then
           echo "The dnsmasq process appears to be dead but pidfile still exists"
        else
           echo "dnsmasq is running, the PID is $PID"
        fi
    else
        echo "dnsmasq is not running"
    fi
}

show_about() {
	echo "$LOGO"
	echo " -Compiled by nelshh @ xda-developers"
	echo " -Contact: henrik@cliffords.nu"
	echo ""
}

show_usage() {
        echo "Usage: opendnsmasq [start|stop|restart|status|about]"
	echo ""
        echo "  -start   Start the daemon"
        echo "  -stop    Stop the daemon"
        echo "  -restart Restart the daemon"
        echo "  -status  Show the daemons current status"
        echo "  -about   Show information about the daemon"
	echo ""
        exit 1
}

case $1 in

'start')
    start_service
    ;;

'stop')
    stop_service
    ;;

'restart')
    stop_service
    start_service
    ;;

'status')
    show_status
    ;;

'about')
    show_about
    ;;

*)
    show_usage
    ;;
esac
